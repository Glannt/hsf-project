<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Sản phẩm</title>
    <link rel="stylesheet" th:href="@{/assets/css/admin-simple.css}" />
</head>
<body>
<div style="text-align:left; margin: 20px 0 10px 30px;">
    <a href="/admin" class="btn">Về trang chính</a>
</div>
<div style="text-align:center; margin-bottom: 30px;">
    <button type="button" class="btn" onclick="showModal('modal-add-pc')">Thêm PC</button>
    <button type="button" class="btn" onclick="showModal('modal-add-item')">Thêm linh kiện</button>
</div>

<!-- Modal Thêm PC -->
<div id="modal-add-pc" class="modal-admin" style="display:none;">
  <div class="modal-content-admin">
    <span class="close-modal" onclick="hideModal('modal-add-pc')">&times;</span>
    <h2 style="text-align:center;">Thêm mới PC</h2>
    <form th:action="@{/admin/product/pc/save}" method="post" id="form-add-pc-modal" onsubmit="return checkRequiredComponents();">
        <div id="pc-warning" style="color:#c0392b; font-weight:bold; margin-bottom:10px; display:none;"></div>
        <label>Tên PC:</label>
        <input type="text" name="name" required/><br/>
        <label>Mô tả:</label>
        <input type="text" name="description"/><br/>
        <label>URL ảnh (có thể nhập nhiều, cách nhau bởi dấu phẩy):</label>
        <input type="text" name="imageUrls" placeholder="https://..."/><br/>
        <label>Chọn linh kiện (giữ Ctrl để chọn nhiều):</label>
        <select name="computerItems" id="add-pc-items" multiple size="6" style="width:100%; margin-bottom:10px;">
            <option th:each="item : ${computerItemsSelect}" th:value="${item.id}" th:text="${item.name}" th:data-category="${item.category != null ? item.category.name : ''}"></option>
        </select><br/>
        <button type="submit">Thêm PC</button>
        <button type="button" class="btn" style="background:#888; margin-left:10px;" onclick="hideModal('modal-add-pc')">Hủy</button>
    </form>
  </div>
</div>

<!-- Modal Thêm linh kiện -->
<div id="modal-add-item" class="modal-admin" style="display:none;">
  <div class="modal-content-admin">
    <span class="close-modal" onclick="hideModal('modal-add-item')">&times;</span>
    <h2 style="text-align:center;">Thêm mới Linh kiện</h2>
    <form th:action="@{/admin/product/item/save}" method="post">
        <label>Tên linh kiện:</label>
        <input type="text" name="name" required/><br/>
        <label>Giá:</label>
        <input type="number" name="price" step="0.01" required/><br/>
        <label>Mô tả:</label>
        <input type="text" name="description"/><br/>
        <label>Brand:</label>
        <input type="text" name="brand"/><br/>
        <label>Model:</label>
        <input type="text" name="model"/><br/>
        <label>Danh mục:</label>
        <select name="category.id" required>
            <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
        </select><br/>
        <button type="submit">Thêm linh kiện</button>
        <button type="button" class="btn" style="background:#888; margin-left:10px;" onclick="hideModal('modal-add-item')">Hủy</button>
    </form>
  </div>
</div>

<!-- Modal Edit PC -->
<div id="modal-edit-pc" class="modal-admin" style="display:none;">
  <div class="modal-content-admin">
    <span class="close-modal" onclick="hideModal('modal-edit-pc')">&times;</span>
    <h2 style="text-align:center;">Sửa PC</h2>
    <form id="form-edit-pc" method="post">
        <label>Tên PC:</label>
        <input type="text" name="name" id="edit-pc-name" required/><br/>
        <label>Mô tả:</label>
        <input type="text" name="description" id="edit-pc-desc"/><br/>
        <label>URL ảnh (có thể nhập nhiều, cách nhau bởi dấu phẩy):</label>
        <input type="text" name="imageUrls" id="edit-pc-imageUrls" placeholder="https://..."/><br/>
        <label>Chọn linh kiện (giữ Ctrl để chọn nhiều):</label>
        <select name="computerItems" id="edit-pc-items" multiple size="6" style="width:100%; margin-bottom:10px;">
            <option th:each="item : ${computerItemsSelect}" th:value="${item.id}" th:text="${item.name}"></option>
        </select><br/>
        <button type="submit">Lưu thay đổi</button>
        <button type="button" class="btn" style="background:#888; margin-left:10px;" onclick="hideModal('modal-edit-pc')">Hủy</button>
    </form>
  </div>
</div>
<!-- Modal Edit Linh kiện -->
<div id="modal-edit-item" class="modal-admin" style="display:none;">
  <div class="modal-content-admin">
    <span class="close-modal" onclick="hideModal('modal-edit-item')">&times;</span>
    <h2 style="text-align:center;">Sửa linh kiện</h2>
    <form id="form-edit-item" method="post">
        <label>Tên linh kiện:</label>
        <input type="text" name="name" id="edit-item-name" required/><br/>
        <label>Giá:</label>
        <input type="number" name="price" id="edit-item-price" step="0.01" required/><br/>
        <label>Mô tả:</label>
        <input type="text" name="description" id="edit-item-desc"/><br/>
        <label>Brand:</label>
        <input type="text" name="brand" id="edit-item-brand"/><br/>
        <label>Model:</label>
        <input type="text" name="model" id="edit-item-model"/><br/>
        <label>Danh mục:</label>
        <select name="category.id" id="edit-item-category" required>
            <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
        </select><br/>
        <button type="submit">Lưu thay đổi</button>
        <button type="button" class="btn" style="background:#888; margin-left:10px;" onclick="hideModal('modal-edit-item')">Hủy</button>
    </form>
  </div>
</div>

<style>
.modal-admin {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(44,62,80,0.18);
  justify-content: center; align-items: center;
}
.modal-content-admin {
  background: #fff;
  margin: 60px auto;
  padding: 30px 40px 20px 40px;
  border-radius: 12px;
  width: 420px;
  box-shadow: 0 4px 32px rgba(44,62,80,0.18);
  position: relative;
  animation: modalFadeIn 0.25s;
}
@keyframes modalFadeIn { from {transform: translateY(-40px); opacity:0;} to {transform: none; opacity:1;} }
.close-modal {
  position: absolute;
  top: 12px; right: 18px;
  font-size: 2rem;
  color: #888;
  cursor: pointer;
  font-weight: bold;
}
.close-modal:hover { color: #2980b9; }
.modal-content-admin label { display:block; margin-top:10px; margin-bottom:2px; }
.modal-content-admin input, .modal-content-admin select {
  width: 100%;
  padding: 7px 10px;
  border: 1px solid #bfc9d1;
  border-radius: 4px;
  margin-bottom: 8px;
  font-size: 1rem;
}
.modal-content-admin button[type="submit"] {
  margin-top: 10px;
}
</style>
<script>
function showModal(id) {
    document.getElementById(id).style.display = 'flex';
}
function hideModal(id) {
    document.getElementById(id).style.display = 'none';
}
// Đóng modal khi bấm nền tối
window.onclick = function(event) {
    if (event.target.classList.contains('modal-admin')) {
        event.target.style.display = 'none';
    }
}
function openEditPCModal(btn) {
    var row = btn.closest('tr');
    var id = row.querySelector('.pc-id').innerText.trim();
    var name = row.querySelector('.pc-name').innerText.trim();
    var desc = row.querySelectorAll('td')[2].innerText.trim();
    var imageUrls = row.querySelectorAll('td')[3].innerText.trim(); // Lấy URL ảnh
    document.getElementById('edit-pc-name').value = name;
    document.getElementById('edit-pc-desc').value = desc;
    document.getElementById('edit-pc-imageUrls').value = imageUrls; // Gán URL ảnh
    // Reset multi-select
    var select = document.getElementById('edit-pc-items');
    for (var i = 0; i < select.options.length; i++) select.options[i].selected = false;
    // Không fill linh kiện vì thiếu dữ liệu, cần JS nâng cao nếu muốn
    var form = document.getElementById('form-edit-pc');
    form.action = '/admin/product/pc/edit/' + id;
    showModal('modal-edit-pc');
}
function openEditItemModal(btn) {
    var row = btn.closest('tr');
    var id = row.querySelector('.item-id').innerText.trim();
    var name = row.querySelector('.item-name').innerText.trim();
    var price = row.querySelector('.item-price').innerText.trim();
    document.getElementById('edit-item-name').value = name;
    document.getElementById('edit-item-price').value = price;
    // Không fill các trường khác vì thiếu dữ liệu, cần JS nâng cao nếu muốn
    var form = document.getElementById('form-edit-item');
    form.action = '/admin/product/item/edit/' + id;
    showModal('modal-edit-item');
}
function checkRequiredComponents() {
    var select = document.getElementById('add-pc-items');
    var selected = Array.from(select.selectedOptions);
    var required = ['CPU', 'Motherboard', 'RAM', 'Storage', 'PSU', 'Case'];
    var found = {};
    selected.forEach(opt => {
        var cat = opt.getAttribute('data-category');
        if (cat) found[cat] = true;
    });
    var missing = required.filter(cat => !found[cat]);
    var warning = document.getElementById('pc-warning');
    if (missing.length > 0) {
        warning.style.display = 'block';
        warning.innerText = 'Cảnh báo: Bạn chưa chọn đủ các linh kiện bắt buộc: ' + missing.join(', ');
    } else {
        warning.style.display = 'none';
    }
    return true; // vẫn cho submit
}
</script>

<h1>Danh sách PC</h1>
<table border="1">
    <thead>
    <tr>
        <th>STT</th>
        <th>Mã PC</th>
        <th>Tên PC</th>
        <th>Giá</th>
        <th>Hành động</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="pc, iterStat : ${pcs.content}">
        <td th:text="${iterStat.index + 1}"></td>
        <td th:text="${pc.id}" class="pc-id"></td>
        <td th:text="${pc.name}" class="pc-name"></td>
        <td th:text="${pc.price}"></td>
        <td>
            <button type="button" class="btn" onclick="openEditPCModal(this)">Sửa</button>
            <form th:action="@{'/admin/product/pc/delete/' + ${pc.id}}" method="post" style="display:inline;">
                <button type="submit" onclick="return confirm('Bạn có chắc muốn xóa PC này?')">Xóa</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>
<div class="pagination">
    <span th:if="${pcs.hasPrevious()}" >
        <a th:href="@{'/admin/product?pcPage=' + ${pcs.number - 1} + '&computerItemPage=' + ${computerItems.number}}">Trang trước</a>
    </span>
    <span>Trang <span th:text="${pcs.number + 1}"></span> / <span th:text="${pcs.totalPages}"></span></span>
    <span th:if="${pcs.hasNext()}" >
        <a th:href="@{'/admin/product?pcPage=' + ${pcs.number + 1} + '&computerItemPage=' + ${computerItems.number}}">Trang sau</a>
    </span>
</div>

<h1>Danh sách Linh kiện</h1>
<table border="1">
    <thead>
    <tr>
        <th>STT</th>
        <th>Mã LK</th>
        <th>Tên linh kiện</th>
        <th>Giá</th>
        <th>Danh mục</th>
        <th>Hành động</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item, iterStat : ${computerItems.content}">
        <td th:text="${iterStat.index + 1}"></td>
        <td th:text="${item.id}" class="item-id"></td>
        <td th:text="${item.name}" class="item-name"></td>
        <td th:text="${item.price}" class="item-price"></td>
        <td th:text="${item.category != null ? item.category.name : 'N/A'}" class="item-category"></td>
        <td>
            <button type="button" class="btn" onclick="openEditItemModal(this)">Sửa</button>
            <form th:action="@{'/admin/product/item/delete/' + ${item.id}}" method="post" style="display:inline;">
                <button type="submit" onclick="return confirm('Bạn có chắc muốn xóa linh kiện này?')">Xóa</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>
<div class="pagination">
    <span th:if="${computerItems.hasPrevious()}" >
        <a th:href="@{'/admin/product?pcPage=' + ${pcs.number} + '&computerItemPage=' + ${computerItems.number - 1}}">Trang trước</a>
    </span>
    <span>Trang <span th:text="${computerItems.number + 1}"></span> / <span th:text="${computerItems.totalPages}"></span></span>
    <span th:if="${computerItems.hasNext()}" >
        <a th:href="@{'/admin/product?pcPage=' + ${pcs.number} + '&computerItemPage=' + ${computerItems.number + 1}}">Trang sau</a>
    </span>
</div>
</body>
</html>
