<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Đơn hàng</title>
  <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" th:href="@{/assets/css/style.css}" />
  <link rel="stylesheet" th:href="@{/assets/css/admin-product.css}" />
  <style>
    .sidebar { width: 260px; }
    .main-content { padding-left: 260px; }
    @media (max-width: 991.98px) {
      .main-content { padding-left: 0; }
    }
  </style>
</head>
<body class="bg-light">

<nav id="sidebarMenu" class="d-lg-block bg-white sidebar collapse border-end min-vh-100 position-fixed">
  <div class="position-sticky">
    <div class="list-group list-group-flush mx-3 mt-4">
      <a th:href="@{/admin/product}" class="list-group-item list-group-item-action py-3 ripple d-flex align-items-center">
        <i class="fas fa-boxes-stacked fa-fw me-3"></i><span>Sản phẩm</span>
      </a>
      <a th:href="@{/admin/order}" class="list-group-item list-group-item-action py-3 ripple d-flex align-items-center active">
        <i class="fas fa-receipt fa-fw me-3"></i><span>Đơn hàng</span>
      </a>
      <a th:href="@{/admin/user}" class="list-group-item list-group-item-action py-3 ripple d-flex align-items-center">
        <i class="fas fa-users fa-fw me-3"></i><span>Người dùng</span>
      </a>
    </div>
  </div>
</nav>

<main class="main-content">
  <div class="container-fluid py-4">

    <header class="d-flex justify-content-between align-items-center mb-4">
      <button class="btn btn-primary d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu"><i class="fas fa-bars"></i></button>
      <h2 class="text-primary mb-0 d-none d-lg-block">Quản lý Đơn hàng</h2>
      <form th:action="@{/logout}" method="post">
        <button type="submit" class="btn btn-outline-danger"><i class="fas fa-sign-out-alt me-1"></i> Logout</button>
      </form>
    </header>

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
      <span th:text="${success}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
      <span th:text="${error}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-list me-2"></i> Danh sách Đơn hàng</h5></div>
      <div class="card-body p-0">
        <div th:if="${orders != null and !orders.isEmpty()}" class="table-responsive">
          <table class="table table-hover table-vcenter mb-0">
            <thead class="table-light">
            <tr>
              <th>Mã đơn</th>
              <th>Khách hàng</th>
              <th>Trạng thái</th>
              <th class="text-end">Tổng tiền</th>
              <th class="text-center">Ngày đặt</th>
              <th class="text-center">Hành động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="order : ${orders.content}">
              <td class="align-middle fw-bold text-primary" th:text="${order.orderNumber}">ORD-123</td>
              <td class="align-middle" th:text="${order.user.username}">Customer</td>
              <td class="align-middle">
                <th:block th:switch="${order.status.toString()}">
                  <span th:case="'PENDING'" class="badge bg-warning text-dark">Chờ xử lý</span>
                  <span th:case="'CONFIRMED'" class="badge bg-info text-dark">Đã xác nhận</span>
                  <span th:case="'SHIPPED'" class="badge bg-primary">Đang giao</span>
                  <span th:case="'DELIVERED'" class="badge bg-success">Đã giao</span>
                  <span th:case="'CANCELLED'" class="badge bg-danger">Đã hủy</span>
                  <span th:case="*" class="badge bg-secondary" th:text="${order.status}">Khác</span>
                </th:block>
              </td>
              <td class="align-middle text-end" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">1,000,000 ₫</td>
              <td class="align-middle text-center" th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy') : '-'}">01/01/2025</td>
              <td class="align-middle text-center">
                <button type="button" class="btn btn-sm btn-outline-info" title="Xem chi tiết"
                        data-bs-toggle="modal"
                        data-bs-target="#orderDetailModal"
                        th:data-order-id="${order.id}">
                  <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-warning" title="Cập nhật"
                        data-bs-toggle="modal"
                        data-bs-target="#updateStatusModal"
                        th:data-order-id="${order.id}"
                        th:data-order-number="${order.orderNumber}"
                        th:data-current-status="${order.status.toString()}">
                  <i class="fas fa-edit"></i>
                </button>

                <div th:id="'details-' + ${order.id}" style="display: none;">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <p><strong>Mã đơn:</strong> <span th:text="${order.orderNumber}"></span></p>
                      <p><strong>Khách hàng:</strong> <span th:text="${order.user.username}"></span></p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Tổng tiền:</strong> <strong class="text-danger" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></strong></p>
                      <p><strong>Địa chỉ:</strong> <span th:text="${order.shippingAddress}"></span></p>
                    </div>
                  </div>
                  <h6>Sản phẩm trong đơn:</h6>
                  <table class="table table-sm table-bordered">
                    <thead><tr><th>Sản phẩm</th><th>SL</th><th class="text-end">Thành tiền</th></tr></thead>
                    <tbody>
                    <tr th:each="item : ${order.orderItems}">
                      <td th:text="${item.productName}"></td>
                      <td th:text="${item.quantity}"></td>
                      <td class="text-end" th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <div th:if="${orders == null or orders.isEmpty()}" class="text-center p-5">
          <h5 class="text-muted">Không có đơn hàng nào.</h5>
        </div>
      </div>
      <div class="card-footer bg-white" th:if="${orders.totalPages > 1}">
      </div>
    </div>
  </div>
</main>

<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="updateStatusForm" method="post"> <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cập nhật đơn hàng: <strong id="modalOrderNumber"></strong></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="newStatus" class="form-label">Trạng thái mới:</label>
        <select id="newStatus" name="status" class="form-select">
          <option value="PENDING">Chờ xử lý</option>
          <option value="CONFIRMED">Đã xác nhận</option>
          <option value="SHIPPED">Đang giao</option>
          <option value="DELIVERED">Đã giao</option>
          <option value="CANCELLED">Đã hủy</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
      </div>
    </div>
    </form>
  </div>
</div>

<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết Đơn hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="orderDetailsContent">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // === Script cho Modal Cập nhật Trạng thái ===
    const updateStatusModal = document.getElementById('updateStatusModal');
    updateStatusModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const orderId = button.getAttribute('data-order-id');
      const orderNumber = button.getAttribute('data-order-number');
      const currentStatus = button.getAttribute('data-current-status');

      const form = updateStatusModal.querySelector('#updateStatusForm');
      form.action = `/admin/order/${orderId}`; // Đặt action cho form

      updateStatusModal.querySelector('#modalOrderNumber').textContent = orderNumber;
      updateStatusModal.querySelector('#newStatus').value = currentStatus;
    });

    // === Script cho Modal Xem Chi tiết (Đơn giản hơn) ===
    const orderDetailModal = document.getElementById('orderDetailModal');
    orderDetailModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const orderId = button.getAttribute('data-order-id');

      // Tìm div ẩn chứa chi tiết của đơn hàng
      const hiddenDetailsDiv = document.getElementById('details-' + orderId);

      // Lấy vùng nội dung của modal
      const modalContent = orderDetailModal.querySelector('#orderDetailsContent');

      // Copy HTML từ div ẩn vào modal
      if (hiddenDetailsDiv) {
        modalContent.innerHTML = hiddenDetailsDiv.innerHTML;
      } else {
        modalContent.innerHTML = '<p class="text-danger">Không tìm thấy chi tiết đơn hàng.</p>';
      }
    });
  });
</script>
</body>
</html>