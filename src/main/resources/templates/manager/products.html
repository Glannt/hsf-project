<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manager - Product Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
</head>
<body class="bg-light">
<div class="container mt-4">
    <!-- Header with Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <h2 class="text-primary mb-0 me-4">Manager Dashboard</h2>
            <nav class="navbar navbar-expand-lg navbar-light">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/manager}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/manager/products}">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/manager/users}">Users</a>
                    </li>
                </ul>
            </nav>
        </div>
        <form th:action="@{/logout}" method="post" style="display:inline;">
            
            <button type="submit" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt"></i> Log out
            </button>
        </form>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-secondary">Product Management</h3>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                <li class="breadcrumb-item"><a th:href="@{/manager}">Manager</a></li>
                <li class="breadcrumb-item active">Products</li>
            </ol>
        </nav>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:if="${param.success == 'item_added'}">Computer item "<span th:text="${param.message}"></span>" added successfully!</span>
        <span th:if="${param.success == 'item_updated'}">Computer item updated successfully!</span>
        <span th:if="${param.success == 'item_deleted'}">Computer item deleted successfully!</span>
        <span th:if="${param.success == 'pc_added'}">PC "<span th:text="${param.message}"></span>" added successfully!</span>
        <span th:if="${param.success == 'pc_deleted'}">PC deleted successfully!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${param.error == 'item_add_failed'} ? 'Failed to add computer item!' :
                       ${param.error == 'item_update_failed'} ? 'Failed to update computer item!' :
                       ${param.error == 'item_delete_failed'} ? 'Failed to delete computer item!' :
                       ${param.error == 'pc_add_failed'} ? 'Failed to add PC!' :
                       ${param.error == 'pc_delete_failed'} ? 'Failed to delete PC!' : 'Operation failed!'"></span>
        <span th:if="${param.message}" th:text="' - ' + ${param.message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- PC Management Section -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">PC Management</h5>
            <a th:href="@{/manager/products/add-pc}" class="btn btn-primary">
                <i class="icon-plus"></i> Add New PC
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Price (VND)</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="pc : ${pcs.content}">
                            <td th:text="${pc.id}"></td>
                            <td th:text="${pc.name}"></td>
                            <td th:text="${#numbers.formatInteger(pc.price, 0, 'COMMA')}"></td>
                            <td th:text="${pc.description}"></td>
                            <td>
                                <button class="btn btn-info btn-sm" data-toggle="modal" th:data-target="'#viewPcModal' + ${pc.id}">
                                    <i class="icon-eye"></i> View
                                </button>
                                <button class="btn btn-warning btn-sm" th:attr="data-id=${pc.id}" onclick="openEditModalFromList(this, 'pc')">
                                    <i class="icon-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" th:attr="data-id=${pc.id}, data-name=${pc.name}" onclick="deletePC(this)">
                                    <i class="icon-trash-2"></i> Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Computer Items Management Section -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Computer Items Management</h5>
            <a th:href="@{/manager/products/add-item}" class="btn btn-success">
                <i class="icon-plus"></i> Add New Item
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Price (VND)</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${computerItems.content}">
                            <td th:text="${item.id}"></td>
                            <td th:text="${item.name}"></td>
                            <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')}"></td>
                            <td th:text="${item.category != null ? item.category.name : 'N/A'}"></td>
                            <td th:text="${item.brand != null ? item.brand : 'N/A'}"></td>
                            <td>
                                <button class="btn btn-info btn-sm" data-toggle="modal" th:data-target="'#viewItemModal' + ${item.id}">
                                    <i class="icon-eye"></i> View
                                </button>
                                <button class="btn btn-warning btn-sm" th:attr="data-id=${item.id}" onclick="openEditModalFromList(this, 'computerItem')">
                                    <i class="icon-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" th:attr="data-id=${item.id}, data-name=${item.name}" onclick="deleteComputerItem(this)">
                                    <i class="icon-trash-2"></i> Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add PC Modal -->
<div class="modal fade" id="addPcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add New PC</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <form th:action="@{/manager/products/pc/save}" method="post">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pcName" class="form-label">PC Name *</label>
                                <input type="text" class="form-control" id="pcName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pcPrice" class="form-label">Price (VND) *</label>
                                <input type="number" class="form-control" id="pcPrice" name="price" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="pcDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="pcDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add PC</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Computer Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Add New Computer Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <form th:action="@{/manager/products/item/save}" method="post">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="itemName" class="form-label">Item Name *</label>
                                <input type="text" class="form-control" id="itemName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="itemPrice" class="form-label">Price (VND) *</label>
                                <input type="number" class="form-control" id="itemPrice" name="price" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="itemBrand" class="form-label">Brand</label>
                                <input type="text" class="form-control" id="itemBrand" name="brand">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="itemModel" class="form-label">Model</label>
                                <input type="text" class="form-control" id="itemModel" name="model">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="itemCategory" class="form-label">Category</label>
                        <select class="form-select" id="itemCategory" name="category.id">
                            <option value="">Select Category</option>
                            <option th:each="category : ${categories}" 
                                    th:value="${category.id}" 
                                    th:text="${category.name}">Category Name</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="itemDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="itemDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View PC Modals -->
<div th:each="pc : ${pcs.content}" class="modal fade" th:id="'viewPcModal' + ${pc.id}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white" style="position: relative;">
                <h5 class="modal-title">PC Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; top: 8px; right: 16px; z-index: 10; font-size: 2rem; color: #fff; opacity: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-6"><strong>ID:</strong> <span th:text="${pc.id}"></span></div>
                    <div class="col-md-6"><strong>Name:</strong> <span th:text="${pc.name}"></span></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6"><strong>Price:</strong> <span th:text="${#numbers.formatInteger(pc.price, 0, 'COMMA')}"></span> VND</div>
                    <div class="col-md-6"><strong>Description:</strong> <span th:text="${pc.description}"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Item Modals -->
<div th:each="item : ${computerItems.content}" class="modal fade" th:id="'viewItemModal' + ${item.id}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white" style="position: relative;">
                <h5 class="modal-title">Component Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; top: 8px; right: 16px; z-index: 10; font-size: 2rem; color: #fff; opacity: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-6"><strong>ID:</strong> <span th:text="${item.id}"></span></div>
                    <div class="col-md-6"><strong>Name:</strong> <span th:text="${item.name}"></span></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6"><strong>Price:</strong> <span th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')}"></span> VND</div>
                    <div class="col-md-6"><strong>Category:</strong> <span th:text="${item.category != null ? item.category.name : 'N/A'}"></span></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6"><strong>Brand:</strong> <span th:text="${item.brand != null ? item.brand : 'N/A'}"></span></div>
                    <div class="col-md-6"><strong>Model:</strong> <span th:text="${item.model != null ? item.model : 'N/A'}"></span></div>
                </div>
                <div class="row mb-2">
                    <div class="col-12"><strong>Description:</strong> <span th:text="${item.description}"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS: Đặt ở cuối body để đảm bảo load đúng thứ tự -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/assets/js/main.js}"></script>
<script th:inline="javascript">
    window.computerItems = [[${computerItems.content}]];
    window.pcs = [[${pcs.content}]];
    window.categories = [[${categories}]];
</script>

<!-- Edit Product Modal -->
<div class="modal fade" id="modalEditProduct" tabindex="-1" aria-labelledby="edit-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white rounded-top-4" style="position: relative;">
                <h5 class="modal-title fw-bold" id="edit-modal-title">Chỉnh sửa PC</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: absolute; top: 8px; right: 16px; z-index: 10; font-size: 2rem; color: #fff; opacity: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="edit-product-form" method="post">
                <div class="modal-body" id="modalEditProductBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Delete functions
function deletePC(btn) {
    const id = btn.getAttribute('data-id');
    const name = btn.getAttribute('data-name');
    console.log('Attempting to delete PC:', { id, name });
    
    if (confirm('Are you sure you want to delete PC: ' + name + '?')) {
        console.log('User confirmed deletion, sending request...');
        
        fetch(`/manager/products/pc/delete/${id}`, {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('Response received:', response.status, response.statusText);
            if (response.ok) {
                return response.text();
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Network response was not ok');
                });
            }
        })
        .then(result => {
            console.log('Delete result:', result);
            showSuccessMessage('PC deleted successfully!');
            // Luôn reload trang để đảm bảo UI cập nhật
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorMessage('Error deleting PC: ' + error.message);
        });
    }
}

function deleteComputerItem(btn) {
    const id = btn.getAttribute('data-id');
    const name = btn.getAttribute('data-name');
    console.log('Attempting to delete item:', { id, name });
    
    if (confirm('Are you sure you want to delete item: ' + name + '?')) {
        console.log('User confirmed deletion, sending request...');
        
        fetch(`/manager/products/item/delete/${id}`, {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('Response received:', response.status, response.statusText);
            if (response.ok) {
                return response.text();
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Network response was not ok');
                });
            }
        })
        .then(result => {
            console.log('Delete result:', result);
            showSuccessMessage('Item deleted successfully!');
            // Luôn reload trang để đảm bảo UI cập nhật
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorMessage('Error deleting item: ' + error.message);
        });
    }
}

// Hàm hiển thị thông báo thành công
function showSuccessMessage(message) {
    showMessage(message, 'success');
}

// Hàm hiển thị thông báo lỗi
function showErrorMessage(message) {
    showMessage(message, 'danger');
}

// Hàm hiển thị thông báo chung
function showMessage(message, type) {
    // Tạo thông báo Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    // Thêm vào đầu trang
    const container = document.querySelector('.container');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
    }
    
    // Tự động ẩn sau 3 giây
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// Khởi tạo tooltip cho Bootstrap 4
$(function () {
    $('[data-toggle="tooltip"]').tooltip();
});

// Format VND function
function formatVND(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount);
}

// Edit modal templates
const formEditTemplates = {
    editPc: {
        title: "Edit PC",
        html: `
            <input type="hidden" name="id" id="edit-id" />
            <div class="form-group">
                <label>PC Name</label>
                <input type="text" name="name" class="form-control" id="edit-name" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" class="form-control" id="edit-description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Price (VND)</label>
                <input type="text" class="form-control" id="edit-price-display" />
                <input type="hidden" name="price" id="edit-price" />
            </div>
        `,
    },
    editItem: {
        title: "Edit Computer Item",
        html: `
            <input type="hidden" name="id" id="edit-id" />
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" name="name" class="form-control" id="edit-name" required>
            </div>
            <div class="form-group">
                <label>Price (VND)</label>
                <input type="text" class="form-control" id="edit-price-display" />
                <input type="hidden" name="price" id="edit-price" />
            </div>
            <div class="form-group">
                <label>Category</label>
                <select class="form-control" name="category.id" id="edit-category-select" required>
                    <option value="" disabled>-- Select Category --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Brand</label>
                <input type="text" class="form-control" name="brand" id="edit-brand" />
            </div>
            <div class="form-group">
                <label>Model</label>
                <input type="text" class="form-control" name="model" id="edit-model" />
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" class="form-control" id="edit-description" rows="3"></textarea>
            </div>
        `,
    },
};

// Price input binding
function initPriceInputBinding() {
    const priceDisplay = document.getElementById("edit-price-display");
    const priceHidden = document.getElementById("edit-price");

    if (!priceDisplay || !priceHidden) return;

    priceDisplay.addEventListener("input", function () {
        const raw = this.value.replace(/[^\d]/g, "");
        priceHidden.value = raw;
        this.value = raw ? formatVND(raw) : "";
    });

    priceDisplay.addEventListener("keypress", function (e) {
        if (!/[0-9]/.test(String.fromCharCode(e.which))) {
            e.preventDefault();
        }
    });
}

// Open edit modal
function openEditModalFromList(button, type = "computerItem") {
    const id = button.getAttribute("data-id");
    console.log("Opening edit modal for ID:", id, "Type:", type);
    const list = type === "pc" ? window.pcs : window.computerItems;
    const item = list.find((p) => String(p.id) === id);
    if (!item) return alert("Product not found.");

    const form = document.getElementById("edit-product-form");
    form.action = type === "pc" 
        ? `/manager/products/pc/edit/${item.id}`
        : `/manager/products/item/edit/${item.id}`;

    const template = formEditTemplates[type === "pc" ? "editPc" : "editItem"];
    document.getElementById("edit-modal-title").textContent = template.title;
    document.getElementById("modalEditProductBody").innerHTML = template.html;

    // Bind common data
    document.getElementById("edit-id").value = item.id || "";
    document.getElementById("edit-name").value = item.name || "";
    const price = item.price || 0;
    const priceInput = document.getElementById("edit-price");
    const priceDisplay = document.getElementById("edit-price-display");
    if (priceInput) priceInput.value = price;
    if (priceDisplay) priceDisplay.value = formatVND(price);

    if (type === "pc") {
        document.getElementById("edit-description").value = item.description || "";
    } else {
        document.getElementById("edit-description").value = item.description || "";
        document.getElementById("edit-brand").value = item.brand || "";
        document.getElementById("edit-model").value = item.model || "";
        
        // Bind category select
        const catSelect = document.getElementById("edit-category-select");
        if (catSelect && window.categories) {
            catSelect.innerHTML = `
                <option value="" disabled>-- Select Category --</option>
                ${window.categories
                    .map((c) =>
                        `<option value="${c.id}" ${
                            item.category?.id === c.id ? "selected" : ""
                        }>${c.name}</option>`
                    )
                    .join("")}
            `;
        }
    }

    // Initialize price binding
    initPriceInputBinding();

    $("#modalEditProduct").modal("show");
}
</script>
</body>
</html> 